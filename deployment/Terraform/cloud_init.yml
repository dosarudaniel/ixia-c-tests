#cloud-config
package_upgrade: true
packages:
  - awscli
  - docker.io
  - docker-compose
  - dpdk-kmods-dkms
  - jq
  - python3-pip
  - python3.10-venv
groups:
  - docker
users:
  - default
  - name: ${UserName}
    groups: docker
runcmd:
  - sudo -H -u ${UserName} bash -c 'git clone ${GitRepoUrl} $HOME/${GitRepoName}'
  - echo ${KengContainerRegistryToken} | docker login ${KengContainerRegistry} -u ${KengContainerRegistryUser} --password-stdin
  - docker pull ${KengControllerImage}
  - docker pull ${KengTrafficEngineImage}
  - docker logout ${KengContainerRegistry}
  - docker images
  - sudo -H -u ${UserName} bash -c 'echo "alias python=python3" >> $HOME/.bashrc'
  - sudo -H -u ${UserName} bash -c 'echo "alias pip=pip3" >> $HOME/.bashrc'
  - python3 -m pip install --upgrade pip
  - python3 --version
  - pip3 --version
  - sudo -H -u ${UserName} bash -c 'python3 -m venv $HOME/venv'
  - sudo -H -u ${UserName} bash -c 'source $HOME/venv/bin/activate; pip install -r $HOME/${GitRepoName}/py/requirements.txt; deactivate'
  - AgentEth1LogicalName=$(lshw -C network -json | jq .[1].logicalname --raw-output)
  - AgentEth1BusInfo=$(lshw -C network -json | jq .[1].businfo --raw-output)
  - AgentEth2LogicalName=$(lshw -C network -json | jq .[2].logicalname --raw-output)
  - AgentEth2BusInfo=$(lshw -C network -json | jq .[2].businfo --raw-output)
  - AgentEth3LogicalName=$(lshw -C network -json | jq .[3].logicalname --raw-output)
  - AgentEth3BusInfo=$(lshw -C network -json | jq .[3].businfo --raw-output)
  - sed -i "s/pci@eth1/$AgentEth1BusInfo/g" /home/${UserName}/${GitRepoName}/deployment/docker-compose.yaml
  - sed -i "s/pci@eth2/$AgentEth2BusInfo/g" /home/${UserName}/${GitRepoName}/deployment/docker-compose.yaml
  - sed -i "s/pci@eth3/$AgentEth3BusInfo/g" /home/${UserName}/${GitRepoName}/deployment/docker-compose.yaml
  - modprobe uio
  - modprobe igb_uio
  - sudo -H -u ${UserName} bash -c 'git clone https://github.com/DPDK/dpdk.git $HOME/dpdk'
  - /home/${UserName}/dpdk/usertools/dpdk-devbind.py -b igb_uio $AgentEth1LogicalName -s --force
  - /home/${UserName}/dpdk/usertools/dpdk-devbind.py -b igb_uio $AgentEth2LogicalName -s --force
  - /home/${UserName}/dpdk/usertools/dpdk-devbind.py -b igb_uio $AgentEth3LogicalName -s --force
  - chmod +x /home/${UserName}/${GitRepoName}/*.sh
  - chmod +x /home/${UserName}/${GitRepoName}/deployment/setup.sh
  - /home/${UserName}/${GitRepoName}/deployment/setup.sh
  - sudo -H -u ${UserName} bash -c 'docker-compose -f $HOME/${GitRepoName}/deployment/docker-compose.yaml up -d'
  - sudo -H -u ${UserName} bash -c 'docker-compose -f $HOME/${GitRepoName}/deployment/docker-compose.yaml ps'